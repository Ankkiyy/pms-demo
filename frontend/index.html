<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Monitoring Station</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --muted: #6b7280;
        --accent: #22d3ee;
        --danger: #f87171;
        --success: #4ade80;
      }

      * {
        box-sizing: border-box;
      }

      input[type="checkbox"] {
        accent-color: var(--accent);
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 20% 20%, #0b1224, #0a0f1c 40%),
          radial-gradient(circle at 80% 0%, #112042, #0a0f1c 30%), var(--bg);
        color: #e5e7eb;
        min-height: 100vh;
      }

      header {
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        backdrop-filter: blur(8px);
        background: rgba(15, 23, 42, 0.8);
        border-bottom: 1px solid #1f2937;
        z-index: 10;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .pulse {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7);
        animation: pulse 2.5s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.6);
        }
        70% {
          box-shadow: 0 0 0 12px rgba(34, 211, 238, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(34, 211, 238, 0);
        }
      }

      main {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 16px;
        padding: 0 16px 32px;
      }

      .panel {
        background: linear-gradient(145deg, #0f172a, #0b1224);
        border: 1px solid #1f2937;
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      }

      .sidebar {
        position: sticky;
        top: 96px;
        height: calc(100vh - 120px);
        overflow-y: auto;
      }

      .sidebar h2 {
        margin: 0 0 12px;
        font-size: 16px;
        color: #cbd5e1;
      }

      .patient-card {
        background: #0a1020;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: border-color 0.2s, transform 0.2s;
      }

      .patient-card:hover,
      .patient-card.active {
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .patient-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .patient-id {
        font-weight: 700;
        color: #e2e8f0;
      }

      .status-pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: #0b1020;
      }

      .status-ok {
        background: rgba(74, 222, 128, 0.9);
      }

      .status-alert {
        background: rgba(248, 113, 113, 0.95);
      }

      .vital-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #cbd5e1;
      }

      .mini-chart {
        height: 64px;
      }

      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 16px;
      }

      .detail-meta h2 {
        margin: 0 0 8px;
      }

      .meta-row {
        display: flex;
        gap: 12px;
        color: #cbd5e1;
        font-size: 14px;
      }

      .chip {
        padding: 6px 12px;
        border-radius: 10px;
        background: #0a1020;
        border: 1px solid #1f2937;
      }

      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px;
      }

      .chart-card {
        background: #0a1020;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
      }

      .chart-card h3 {
        margin: 0 0 8px;
        font-size: 14px;
        color: #cbd5e1;
      }

      .env-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 12px;
      }

      .metric-card {
        background: #0b1224;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 10px 12px;
        display: grid;
        gap: 4px;
      }

      .metric-label {
        font-size: 12px;
        color: var(--muted);
      }

      .metric-value {
        font-weight: 700;
        font-size: 20px;
      }

      .metric-sub {
        font-size: 12px;
        color: #cbd5e1;
      }

      .meter {
        height: 8px;
        background: #0f172a;
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid #1f2937;
      }

      .meter > div {
        height: 100%;
        background: linear-gradient(90deg, #22d3ee, #38bdf8);
      }

      .chat-toggle {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 20;
        padding: 12px 16px;
        border-radius: 12px;
        background: linear-gradient(135deg, #22d3ee, #38bdf8);
        color: #0b1020;
        border: 1px solid #22d3ee;
        font-weight: 700;
        box-shadow: 0 12px 40px rgba(34, 211, 238, 0.4);
        cursor: pointer;
      }

      .chat-panel {
        position: fixed;
        right: 20px;
        top: 96px;
        width: 360px;
        max-width: calc(100vw - 32px);
        background: linear-gradient(145deg, #0f172a, #0b1224);
        border: 1px solid #1f2937;
        border-radius: 14px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        z-index: 30;
        display: grid;
        grid-template-rows: auto 1fr auto;
        transition: transform 0.2s ease, opacity 0.2s ease;
      }

      .chat-panel.hidden {
        opacity: 0;
        pointer-events: none;
        transform: translateY(8px);
      }

      .chat-header {
        padding: 12px;
        border-bottom: 1px solid #1f2937;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .chat-header small {
        color: var(--muted);
      }

      .chat-body {
        max-height: 50vh;
        overflow-y: auto;
        padding: 12px;
        display: grid;
        gap: 10px;
      }

      .chat-input {
        padding: 12px;
        border-top: 1px solid #1f2937;
        background: rgba(10, 16, 32, 0.7);
        border-radius: 0 0 14px 14px;
      }

      .chat-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      .chat-message .bubble {
        background: #0b1224;
        border: 1px solid #1f2937;
      }

      .assistant {
        margin-top: 16px;
        background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), #0a1020);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
      }

      textarea {
        width: 100%;
        background: #0b1224;
        color: #e5e7eb;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
        resize: vertical;
        min-height: 70px;
        font-family: inherit;
      }

      button {
        background: linear-gradient(90deg, #22d3ee, #38bdf8);
        color: #0b1020;
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(34, 211, 238, 0.35);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .assistant-response {
        margin-top: 10px;
        padding: 10px;
        border-radius: 10px;
        background: #0b1224;
        border: 1px solid #1f2937;
        color: #e5e7eb;
        min-height: 40px;
      }

      .assistant-response .bubble {
        position: relative;
        background: #111b2f;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px 16px 16px;
        box-shadow: 0 12px 30px rgba(8, 12, 24, 0.35);
      }

      .assistant-response .bubble .label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
        margin-bottom: 8px;
        color: #bae6fd;
      }

      .assistant-response .bubble .close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 14px;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 6px;
        box-shadow: none;
        transition: background 0.2s, color 0.2s;
      }

      .assistant-response .bubble .close:hover,
      .assistant-response .bubble .close:focus {
        background: rgba(148, 163, 184, 0.15);
        color: #f8fafc;
        outline: none;
      }

      .assistant-response .bubble .response {
        display: grid;
        gap: 12px;
        font-size: 14px;
        line-height: 1.5;
      }

      .assistant-response .bubble details.think {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 8px 12px;
      }

      .assistant-response .bubble details.think summary {
        cursor: pointer;
        color: #38bdf8;
        font-weight: 600;
      }

      .assistant-response .bubble details.think pre {
        margin: 8px 0 0;
        white-space: pre-wrap;
        color: #cbd5e1;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
      }

      .empty-state {
        padding: 20px;
        text-align: center;
        color: #94a3b8;
        border: 1px dashed #1f2937;
        border-radius: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="pulse"></div>
        <div>
          <div>Patient Monitoring Station</div>
          <small style="color: var(--muted)"
            >Live sensor feed + AI assistant</small
          >
        </div>
      </div>
      <div style="color: var(--muted); font-size: 14px">
        Streaming vitals in real time
      </div>
    </header>

    <main>
      <section class="panel sidebar">
        <h2>Patients</h2>
        <div id="patientList"></div>
      </section>

      <section class="panel">
        <div class="detail-header">
          <div class="detail-meta">
            <h2 id="patientTitle">Select a patient</h2>
            <div class="meta-row">
              <div class="chip" id="patientHash">—</div>
              <div class="chip" id="patientUpdated">—</div>
            </div>
          </div>
          <div class="chip" id="patientStatus">Waiting for data…</div>
        </div>

        <div id="detailMetrics" class="vital-grid" style="margin-bottom: 12px">
          <div>HR: —</div>
          <div>SpO₂: —</div>
          <div>Body Temp: —</div>
          <div>Activity: —</div>
          <div>Steps: —</div>
        </div>

        <div id="environmentStatus" class="env-grid">
          <div class="metric-card">
            <div class="metric-label">Room Temp</div>
            <div class="metric-value">—</div>
            <div class="metric-sub">Monitoring ambient comfort</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Humidity</div>
            <div class="metric-value">—</div>
            <div class="metric-sub">—</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Activity</div>
            <div class="metric-value">—</div>
            <div class="metric-sub">Accelerometer feed</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Steps walked</div>
            <div class="metric-value">—</div>
            <div class="metric-sub">Daily total</div>
          </div>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <h3>Heart Rate (bpm)</h3>
            <canvas id="hrChart" height="120"></canvas>
          </div>
          <div class="chart-card">
            <h3>SpO₂ (%)</h3>
            <canvas id="spoChart" height="120"></canvas>
          </div>
          <div class="chart-card">
            <h3>Temperature (°C)</h3>
            <canvas id="tempChart" height="120"></canvas>
          </div>
          <div class="chart-card">
            <h3>Room Temp (°C)</h3>
            <canvas id="ambientChart" height="120"></canvas>
          </div>
          <div class="chart-card">
            <h3>Humidity (%)</h3>
            <canvas id="humidityChart" height="120"></canvas>
          </div>
          <div class="chart-card">
            <h3>Activity (0-1)</h3>
            <canvas id="activityChart" height="120"></canvas>
          </div>
          <div class="chart-card">
            <h3>Steps (cumulative)</h3>
            <canvas id="stepsChart" height="120"></canvas>
          </div>
        </div>
      </section>
    </main>

    <button class="chat-toggle" id="chatToggle">AI Assistant</button>

    <div class="chat-panel hidden" id="chatPanel">
      <div class="chat-header">
        <div>
          <div style="font-weight: 700">AI Rounds Assistant</div>
          <small id="chatContext">Context: select a patient to focus.</small>
        </div>
        <button class="close" id="chatClose" aria-label="Close chat">✕</button>
      </div>
      <div class="chat-body" id="chatHistory">
        <div class="empty-state">Ask about vitals, room conditions, or activity.</div>
      </div>
      <div class="chat-input">
        <textarea
          id="aiQuestion"
          placeholder="e.g. Is this patient stable? Any oxygen issues?"
        ></textarea>
        <div class="chat-controls">
          <label style="display: flex; align-items: center; gap: 6px; color: #cbd5e1">
            <input type="checkbox" id="useOllama" />
            <span>Use Ollama agentic chain</span>
          </label>
          <small style="color: var(--muted)">
            Uses current vitals with device context when selected.
          </small>
          <button id="askButton" style="margin-left: auto">Send</button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8000";
      const MAX_POINTS = 40;
      const patients = new Map();
      const miniCharts = new Map();
      let selectedId = null;
      let charts;

      const ACTIVITY_THRESHOLDS = [
        { max: 0.12, label: "sleeping" },
        { max: 0.28, label: "sitting" },
        { max: 0.68, label: "walking" },
        { max: 1, label: "exercising" },
      ];

      function initCharts() {
        const options = (color) => ({
          type: "line",
          data: {
            labels: [],
            datasets: [
              { data: [], borderColor: color, tension: 0.3, pointRadius: 0 },
            ],
          },
          options: {
            responsive: true,
            animation: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { display: false }, grid: { display: false } },
              y: { ticks: { color: "#94a3b8" }, grid: { color: "#1f2937" } },
            },
          },
        });

        charts = {
          hr: new Chart(
            document.getElementById("hrChart").getContext("2d"),
            options("#22d3ee")
          ),
          spo: new Chart(
            document.getElementById("spoChart").getContext("2d"),
            options("#4ade80")
          ),
          temp: new Chart(
            document.getElementById("tempChart").getContext("2d"),
            options("#fbbf24")
          ),
          ambient: new Chart(
            document.getElementById("ambientChart").getContext("2d"),
            options("#38bdf8")
          ),
          humidity: new Chart(
            document.getElementById("humidityChart").getContext("2d"),
            options("#a78bfa")
          ),
          activity: new Chart(
            document.getElementById("activityChart").getContext("2d"),
            options("#fb7185")
          ),
          steps: new Chart(
            document.getElementById("stepsChart").getContext("2d"),
            options("#f97316")
          ),
        };
      }

      function formatTime(ts) {
        const d = new Date(ts);
        return d.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function deriveActivityState(vitals) {
        if (vitals.activity_state) return vitals.activity_state;
        const score = Number(vitals.activity_level || 0);
        const match = ACTIVITY_THRESHOLDS.find((bucket) => score <= bucket.max);
        return match ? match.label : "walking";
      }

      function formatActivity(vitals) {
        const state = deriveActivityState(vitals);
        const score = Number(vitals.activity_level || 0);
        return {
          state,
          label: state.charAt(0).toUpperCase() + state.slice(1),
          score: score.toFixed(2),
        };
      }

      function updateHistory(record, message) {
        const {
          heart_rate,
          spo2,
          temperature,
          ambient_temperature,
          humidity,
          activity_level,
          steps_walked,
        } = message.vitals;
        const label = formatTime(message.timestamp);
        record.labels.push(label);
        record.heart.push(heart_rate);
        record.spo.push(spo2);
        record.temp.push(temperature);
        record.ambient.push(ambient_temperature);
        record.humidity.push(humidity);
        record.activity.push(activity_level);
        record.steps.push(steps_walked);
        if (record.labels.length > MAX_POINTS) {
          ["labels", "heart", "spo", "temp", "ambient", "humidity", "activity", "steps"].forEach(
            (k) => record[k].shift()
          );
        }
      }

      function setSelected(deviceId) {
        selectedId = deviceId;
        renderDetail();
      }

      function updateChatContext() {
        const context = document.getElementById("chatContext");
        if (!context) return;
        if (selectedId && patients.has(selectedId)) {
          const patient = patients.get(selectedId);
          context.textContent = `Context: ${patient.device_id} (${patient.patient_hash.slice(0, 8)}…)`;
        } else {
          context.textContent = "Context: select a patient to focus.";
        }
      }

      function renderPatients() {
        const container = document.getElementById("patientList");
        container.innerHTML = "";

        if (!patients.size) {
          container.innerHTML =
            '<div class="empty-state">Waiting for device data…</div>';
          return;
        }

        [...patients.values()]
          .sort((a, b) => b.updated - a.updated)
          .forEach((patient) => {
            const card = document.createElement("div");
            card.className =
              "patient-card" +
              (patient.device_id === selectedId ? " active" : "");
            card.onclick = () => setSelected(patient.device_id);

            const alerting = patient.flags.length > 0;
            const activityInfo = formatActivity(patient.vitals);
            card.innerHTML = `
              <div class="patient-header">
                <div class="patient-id">${patient.device_id}</div>
                <div class="status-pill ${
                  alerting ? "status-alert" : "status-ok"
                }">${alerting ? "Attention" : "Stable"}</div>
              </div>
              <div class="vital-grid">
                <div>HR ${patient.vitals.heart_rate.toFixed(0)}</div>
                <div>SpO₂ ${patient.vitals.spo2.toFixed(0)}%</div>
                <div>Temp ${patient.vitals.temperature.toFixed(1)}°C</div>
                <div>Room ${patient.vitals.ambient_temperature.toFixed(1)}°C</div>
                <div>Hum ${patient.vitals.humidity.toFixed(0)}%</div>
                <div>Act ${activityInfo.label}</div>
                <div>Steps ${patient.vitals.steps_walked.toLocaleString()}</div>
              </div>
              <canvas class="mini-chart" id="mini-${
                patient.device_id
              }"></canvas>
            `;

            container.appendChild(card);
            renderMiniChart(patient);
          });
      }

      function renderMiniChart(patient) {
        const canvas = document.getElementById(`mini-${patient.device_id}`);
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const config = {
          type: "line",
          data: {
            labels: patient.history.labels,
            datasets: [
              {
                data: patient.history.heart,
                borderColor: patient.flags.length ? "#f87171" : "#22d3ee",
                tension: 0.35,
                pointRadius: 0,
                borderWidth: 2,
                fill: false,
              },
            ],
          },
          options: {
            animation: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false },
            },
          },
        };

        if (miniCharts.has(patient.device_id)) {
          const chart = miniCharts.get(patient.device_id);
          chart.data.labels = patient.history.labels;
          chart.data.datasets[0].data = patient.history.heart;
          chart.update();
        } else {
          miniCharts.set(patient.device_id, new Chart(ctx, config));
        }
      }

      function renderDetail() {
        const title = document.getElementById("patientTitle");
        const hash = document.getElementById("patientHash");
        const updated = document.getElementById("patientUpdated");
        const status = document.getElementById("patientStatus");
        const metrics = document.getElementById("detailMetrics");
        const environment = document.getElementById("environmentStatus");
        updateChatContext();

        if (!selectedId || !patients.has(selectedId)) {
          title.textContent = "Select a patient";
          hash.textContent = "—";
          updated.textContent = "—";
          status.textContent = "Waiting for data…";
          metrics.innerHTML =
            "<div>HR: —</div><div>SpO₂: —</div><div>Body Temp: —</div><div>Activity: —</div>";
          environment.innerHTML = `
            <div class="metric-card">
              <div class="metric-label">Room Temp</div>
              <div class="metric-value">—</div>
              <div class="metric-sub">Monitoring ambient comfort</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Humidity</div>
              <div class="metric-value">—</div>
              <div class="metric-sub">—</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Activity</div>
              <div class="metric-value">—</div>
              <div class="metric-sub">Accelerometer feed</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Live activity</div>
              <div class="metric-value">—</div>
              <div class="metric-sub">Sitting, sleeping, walking, exercising</div>
            </div>`;
          Object.values(charts || {}).forEach((c) => {
            c.data.labels = [];
            c.data.datasets[0].data = [];
            c.update();
          });
          return;
        }

        const patient = patients.get(selectedId);
        title.textContent = `Patient ${patient.device_id}`;
        hash.textContent = `Hash: ${patient.patient_hash.slice(0, 12)}…`;
        updated.textContent = `Updated ${formatTime(patient.timestamp)}`;
        status.textContent = patient.flags.length
          ? `Alerts: ${patient.flags.join(", ")}`
          : "Stable";
        status.style.color = patient.flags.length ? "#0b1020" : "#0b1020";
        status.style.background = patient.flags.length
          ? "rgba(248, 113, 113, 0.95)"
          : "rgba(74, 222, 128, 0.9)";

        const activityInfo = formatActivity(patient.vitals);

        metrics.innerHTML = `
          <div>HR: ${patient.vitals.heart_rate.toFixed(0)} bpm</div>
          <div>SpO₂: ${patient.vitals.spo2.toFixed(0)}%</div>
          <div>Body Temp: ${patient.vitals.temperature.toFixed(1)}°C</div>
          <div>Activity: ${activityInfo.label} (${activityInfo.score})</div>
          <div>Steps: ${patient.vitals.steps_walked.toLocaleString()}</div>
        `;

        environment.innerHTML = `
          <div class="metric-card">
            <div class="metric-label">Room Temp</div>
            <div class="metric-value">${patient.vitals.ambient_temperature.toFixed(1)}°C</div>
            <div class="metric-sub">Comfort ${patient.vitals.ambient_temperature < 21 ? "cool" : patient.vitals.ambient_temperature > 27 ? "warm" : "ideal"}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Humidity</div>
            <div class="metric-value">${patient.vitals.humidity.toFixed(0)}%</div>
            <div class="meter"><div style="width: ${Math.min(100, Math.max(0, patient.vitals.humidity))}%;"></div></div>
            <div class="metric-sub">${patient.vitals.humidity > 60 ? "High humidity nearby" : patient.vitals.humidity < 35 ? "Dry air" : "Comfort range"}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Activity</div>
            <div class="metric-value">${activityInfo.label}</div>
            <div class="meter"><div style="width: ${patient.vitals.activity_level * 100}%; background: linear-gradient(90deg, #34d399, #fb7185);"></div></div>
            <div class="metric-sub">${activityInfo.score} score via accelerometer</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Steps walked</div>
            <div class="metric-value">${patient.vitals.steps_walked.toLocaleString()}</div>
            <div class="metric-sub">Total today from accelerometer</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Live activity</div>
            <div class="metric-value">${activityInfo.label}</div>
            <div class="metric-sub">${
              activityInfo.state === "sleeping"
                ? "Restful / eyes closed"
                : activityInfo.state === "sitting"
                ? "Seated or minimal movement"
                : activityInfo.state === "walking"
                ? "Upright and mobile"
                : "Elevated movement / exercise"
            }</div>
          </div>
        `;

        if (charts) {
          charts.hr.data.labels = patient.history.labels;
          charts.hr.data.datasets[0].data = patient.history.heart;
          charts.hr.update();

          charts.spo.data.labels = patient.history.labels;
          charts.spo.data.datasets[0].data = patient.history.spo;
          charts.spo.update();

          charts.temp.data.labels = patient.history.labels;
          charts.temp.data.datasets[0].data = patient.history.temp;
          charts.temp.update();

          charts.ambient.data.labels = patient.history.labels;
          charts.ambient.data.datasets[0].data = patient.history.ambient;
          charts.ambient.update();

          charts.humidity.data.labels = patient.history.labels;
          charts.humidity.data.datasets[0].data = patient.history.humidity;
          charts.humidity.update();

          charts.activity.data.labels = patient.history.labels;
          charts.activity.data.datasets[0].data = patient.history.activity;
          charts.activity.update();

          charts.steps.data.labels = patient.history.labels;
          charts.steps.data.datasets[0].data = patient.history.steps;
          charts.steps.update();
        }
      }

      function processMessage(message) {
        const flags = [];
        const activityState = deriveActivityState(message.vitals);
        if (message.vitals.heart_rate > 110) flags.push("High HR");
        if (message.vitals.spo2 < 92) flags.push("Low SpO₂");
        if (message.vitals.temperature > 37.8) flags.push("Fever");
        if (message.vitals.fall_detected) flags.push("Fall");
        if (message.vitals.humidity > 65) flags.push("Humid room");
        if (activityState === "exercising" || message.vitals.activity_level > 0.8)
          flags.push("High activity");
        if (activityState === "sleeping") flags.push("Sleeping");

        const existing = patients.get(message.device_id);
        const history = existing
          ? existing.history
          : { labels: [], heart: [], spo: [], temp: [], ambient: [], humidity: [], activity: [], steps: [] };
        ["ambient", "humidity", "activity", "steps"].forEach((key) => {
          if (!history[key]) history[key] = [];
        });
        updateHistory(history, message);

        patients.set(message.device_id, {
          ...message,
          updated: new Date(message.timestamp).getTime(),
          history,
          flags,
        });

        if (!selectedId) {
          selectedId = message.device_id;
        }

        renderPatients();
        renderDetail();
      }

      async function fetchInitial() {
        try {
          const res = await fetch(`${API_BASE}/vitals`);
          const data = await res.json();
          data.forEach(processMessage);
        } catch (err) {
          console.error("Failed to load initial vitals", err);
        }
      }

      function connectStream() {
        const source = new EventSource(`${API_BASE}/stream/vitals`);
        source.onmessage = (event) => {
          const payload = JSON.parse(event.data);
          processMessage(payload);
        };
        source.onerror = () => {
          console.warn("Stream disconnected, retrying…");
          source.close();
          setTimeout(connectStream, 2000);
        };
      }

      async function askAssistant() {
        const button = document.getElementById("askButton");
        const question = document.getElementById("aiQuestion").value.trim();
        const useOllama = document.getElementById("useOllama").checked;
        if (!question) return;

        openChat();

        button.disabled = true;
        const { responseDiv, bubble } = appendChatMessage("assistant", "Thinking…");
        appendChatMessage("user", question);
        document.getElementById("aiQuestion").value = "";
        const payload = { question, use_ollama: useOllama };
        if (useOllama) payload.provider = "ollama";
        if (selectedId) payload.device_id = selectedId;

        try {
          const res = await fetch(`${API_BASE}/ai/ask`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          let content = data.answer || "No answer generated.";

          const thinkMatch = content.match(/<think>[\s\S]*?<\/think>/i);
          if (thinkMatch) {
            const thinkDetails = document.createElement("details");
            thinkDetails.className = "think";
            thinkDetails.innerHTML = `
                  <summary>Thought process</summary>
                  <pre>${thinkMatch[1].trim()}</pre>
                `;
            responseDiv.appendChild(thinkDetails);
            content = content.replace(thinkMatch[0], "");
          }

          const answer = document.createElement("div");
          answer.className = "answer";
          answer.innerHTML = content.trim();
          responseDiv.appendChild(answer);
        } catch (err) {
          console.error(err);
          bubble.querySelector(".label").textContent = "Assistant (error)";
          responseDiv.textContent = "Assistant unavailable.";
        } finally {
          button.disabled = false;
        }
      }

      function appendChatMessage(role, content) {
        const history = document.getElementById("chatHistory");
        if (history.querySelector(".empty-state")) history.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.className = `chat-message ${role}`;
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        const label = document.createElement("div");
        label.className = "label";
        label.textContent = role === "user" ? "You" : "Assistant";
        if (role === "assistant") {
          const close = document.createElement("button");
          close.className = "close";
          close.textContent = "✕";
          close.addEventListener("click", () => wrapper.remove());
          label.appendChild(close);
        }

        const response = document.createElement("div");
        response.className = "response";
        response.innerHTML = content;

        bubble.appendChild(label);
        bubble.appendChild(response);
        wrapper.appendChild(bubble);
        history.appendChild(wrapper);
        history.scrollTop = history.scrollHeight;
        return { responseDiv: response, bubble };
      }

      function openChat() {
        const panel = document.getElementById("chatPanel");
        panel.classList.remove("hidden");
        document.getElementById("aiQuestion").focus();
      }

      function closeChat() {
        const panel = document.getElementById("chatPanel");
        panel.classList.add("hidden");
      }

      function toggleChat() {
        const panel = document.getElementById("chatPanel");
        panel.classList.contains("hidden") ? openChat() : closeChat();
      }

      document
        .getElementById("askButton")
        .addEventListener("click", askAssistant);
      document.getElementById("chatToggle").addEventListener("click", toggleChat);
      document.getElementById("chatClose").addEventListener("click", closeChat);

      window.addEventListener("load", () => {
        initCharts();
        fetchInitial();
        connectStream();
      });
    </script>
  </body>
</html>
